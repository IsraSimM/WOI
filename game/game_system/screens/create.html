<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Nueva Expedicion</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <style>
      :root {
        --bg-0: #0b1216;
        --bg-1: #0f1a20;
        --panel: rgba(13, 24, 30, 0.95);
        --panel-soft: rgba(13, 24, 30, 0.8);
        --line: rgba(46, 112, 142, 0.45);
        --soft: rgba(46, 112, 142, 0.2);
        --text: #e7f0f6;
        --muted: rgba(231, 240, 246, 0.6);
        --accent: #20c7ff;
        --accent-2: #23f1a8;
      }

      body {
        background: radial-gradient(circle at top, #0f1f25 0%, #0a1115 40%, #070b0e 100%);
        color: var(--text);
        font-family: "Rajdhani", "Space Grotesk", sans-serif;
      }

      .page {
        min-height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 26px;
        border-bottom: 1px solid rgba(46, 112, 142, 0.4);
        background: rgba(9, 18, 22, 0.9);
        gap: 12px;
        flex-wrap: wrap;
      }

      .brand {
        display: grid;
        gap: 2px;
        text-transform: uppercase;
      }

      .brand strong {
        letter-spacing: 3px;
        font-size: 14px;
      }

      .brand span {
        font-size: 10px;
        color: var(--muted);
        letter-spacing: 2px;
      }

      .top-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .top-actions .top-exit {
        padding: 10px 14px;
        font-size: 12px;
        letter-spacing: 1px;
        text-transform: uppercase;
        transform: none;
      }

      .top-actions .top-exit:hover {
        transform: none;
      }

      .chip {
        border: var(--ui-border);
        background: var(--ui-bg);
        border-radius: var(--ui-radius);
        padding: 8px 12px;
        font-size: 12px;
        letter-spacing: 1px;
      }

      .content {
        padding: 32px 26px 40px;
        display: grid;
        gap: 24px;
      }

      .hero {
        max-width: 860px;
      }

      .hero h1 {
        font-size: 42px;
        margin-bottom: 6px;
        letter-spacing: 1px;
      }

      .hero p {
        color: var(--muted);
        max-width: 620px;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(320px, 1fr) minmax(260px, 320px);
        gap: 24px;
        align-items: start;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--ui-radius);
        padding: 20px 22px;
        box-shadow: inset 0 0 0 1px var(--soft);
      }

      .panel h3 {
        font-size: 12px;
        letter-spacing: 3px;
        color: var(--accent);
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .field {
        margin-bottom: 16px;
      }

      .field label {
        display: block;
        font-size: 11px;
        letter-spacing: 2px;
        color: var(--muted);
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .field input[type="text"],
      .field input[type="number"],
      .field select {
        width: 100%;
        height: 40px;
        border-radius: var(--ui-radius);
        border: var(--ui-border);
        background: var(--ui-bg);
        color: var(--ui-text);
        padding: 0 12px;
      }

      .toggle-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .toggle-btn {
        padding: 8px 14px;
        border-radius: var(--ui-radius);
        border: var(--ui-border);
        background: var(--ui-bg);
        color: var(--ui-muted);
        font-size: 11px;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .toggle-btn.active {
        border-color: var(--accent);
        color: var(--text);
        background: rgba(32, 199, 255, 0.18);
        box-shadow: 0 0 0 1px rgba(32, 199, 255, 0.2);
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .slider-row {
        display: grid;
        gap: 8px;
      }

      .slider-row input[type="range"] {
        width: 100%;
      }

      .slider-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--muted);
      }

      .seed-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }

      .seed-btn {
        height: 40px;
        border-radius: var(--ui-radius);
        border: var(--ui-border);
        background: var(--ui-bg);
        color: var(--accent);
        letter-spacing: 1px;
        text-transform: uppercase;
        font-size: 11px;
        cursor: pointer;
      }

      .switch {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: var(--ui-radius);
        border: var(--ui-border);
        background: var(--ui-bg);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .switch input[type="checkbox"] {
        width: 44px;
        height: 24px;
        appearance: none;
        background: rgba(20, 32, 40, 0.7);
        border: 1px solid rgba(46, 112, 142, 0.5);
        border-radius: 999px;
        position: relative;
        cursor: pointer;
      }

      .switch input[type="checkbox"]::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        top: 2px;
        left: 3px;
        transition: transform 0.2s ease;
      }

      .switch input[type="checkbox"]:checked::after {
        transform: translateX(20px);
        background: var(--accent-2);
      }

      .summary {
        display: grid;
        gap: 12px;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
      }

      .summary-item span:last-child {
        color: var(--text);
      }

      .actions {
        display: grid;
        gap: 10px;
        margin-top: 16px;
      }

      .action-btn {
        height: 44px;
        border-radius: var(--ui-radius);
        border: var(--ui-border);
        background: var(--ui-bg);
        color: var(--ui-text);
        letter-spacing: 1px;
        text-transform: uppercase;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .action-btn.primary {
        background: rgba(32, 199, 255, 0.2);
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 0 0 1px rgba(32, 199, 255, 0.2);
      }

      .action-btn:hover {
        transform: translateY(-1px);
      }

      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 720px) {
        .content {
          padding: 24px 18px 32px;
        }

        .topbar {
          padding: 14px 18px;
        }

        .top-actions {
          width: 100%;
          justify-content: space-between;
          flex-wrap: wrap;
        }

        .hero h1 {
          font-size: 32px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="topbar">
        <div class="brand">
          <strong>PROTOCOLO NOVA</strong>
          <span>SISTEMA DE DESPLIEGUE v4.2</span>
        </div>
        <div class="top-actions">
          <div class="chip" id="operatorLabel">OPERADOR: CMD_VALKYRIE</div>
          <button class="menu-btn top-exit" data-route="index.html">Salir</button>
        </div>
      </div>

      <div class="content">
        <div class="hero">
          <h1>Nueva Expedicion</h1>
          <p>Configura los parametros antes de iniciar. Una vez iniciada la secuencia, la expedicion no puede ser abortada.</p>
        </div>

        <div class="layout">
          <div class="panel">
            <div class="field">
              <label>Nombre de la mision</label>
              <input type="text" id="missionName" value="EXPEDICION_ANDROMEDA_01" />
            </div>

            <div class="field">
              <label>Modo de juego</label>
              <div class="toggle-group" id="modeGroup"></div>
            </div>

            <div class="field">
              <label>Tamano del mapa</label>
              <div class="toggle-group" id="sizeGroup"></div>
            </div>

            <div class="row">
              <div class="field">
                <label>Ancho manual</label>
                <input type="number" id="widthInput" min="5" step="2" value="21" />
              </div>
              <div class="field">
                <label>Alto manual</label>
                <input type="number" id="heightInput" min="5" step="2" value="21" />
              </div>
            </div>

            <div class="field">
              <label>Nivel de amenaza</label>
              <div class="toggle-group" id="diffGroup"></div>
            </div>

            <div class="row">
              <div class="field">
                <label>Vidas iniciales</label>
                <input type="number" id="livesInput" min="1" max="6" value="3" />
              </div>
              <div class="field">
                <label>Altura del mapa</label>
                <input type="number" id="wallHeightInput" min="1" max="4" value="2" />
              </div>
            </div>

            <div class="field">
              <label>Semilla de generacion (seed)</label>
              <div class="seed-row">
                <input type="text" id="seedInput" placeholder="auto" />
                <button class="seed-btn" id="seedRandom">Aleatorio</button>
              </div>
            </div>

            <div class="field slider-row">
              <label>Radio del minimapa (celdas)</label>
              <input type="range" id="minimapRadius" min="3" max="12" value="7" />
              <div class="slider-meta">
                <span>Corto</span>
                <span id="minimapRadiusValue">7</span>
                <span>Amplio</span>
              </div>
            </div>

            <div class="field">
              <div class="switch">
                <span>Modo pacmanizado</span>
                <input type="checkbox" id="pacmanToggle" />
              </div>
            </div>
          </div>

          <div class="panel">
            <h3>Resumen del sistema</h3>
            <div class="summary" id="summary"></div>
            <div class="actions">
              <button class="action-btn primary" id="startBtn">Comenzar secuencia</button>
              <button class="action-btn" id="loadBtn">Cargar partida guardada</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const CONFIG_KEY = 'game_config_v1';
      const MODE_URL = '../../game_data/modes/modes.json';
      const DIFF_URL = '../../game_data/difficults/difficults.json';

      const missionName = document.getElementById('missionName');
      const modeGroup = document.getElementById('modeGroup');
      const diffGroup = document.getElementById('diffGroup');
      const sizeGroup = document.getElementById('sizeGroup');
      const widthInput = document.getElementById('widthInput');
      const heightInput = document.getElementById('heightInput');
      const livesInput = document.getElementById('livesInput');
      const wallHeightInput = document.getElementById('wallHeightInput');
      const seedInput = document.getElementById('seedInput');
      const seedRandom = document.getElementById('seedRandom');
      const pacmanToggle = document.getElementById('pacmanToggle');
      const minimapRadius = document.getElementById('minimapRadius');
      const minimapRadiusValue = document.getElementById('minimapRadiusValue');
      const summary = document.getElementById('summary');
      const startBtn = document.getElementById('startBtn');
      const loadBtn = document.getElementById('loadBtn');

      const sizes = [
        { id: 'small', label: 'PEQUENO', width: 15, height: 15 },
        { id: 'medium', label: 'MEDIANO', width: 21, height: 21 },
        { id: 'large', label: 'GRANDE', width: 31, height: 31 },
      ];

      const state = {
        name: missionName.value.trim(),
        mode: 'modo_classic',
        difficulty: 'normal',
        width: 21,
        height: 21,
        wallHeight: 2,
        lives: 3,
        seed: '',
        pacman: false,
        minimapRadius: 7,
      };

      function normalizeOdd(value, fallback) {
        let n = Number(value);
        if (!Number.isFinite(n)) n = fallback;
        n = Math.max(5, Math.round(n));
        if (n % 2 === 0) n += 1;
        return n;
      }

      function setActive(group, value) {
        group.querySelectorAll('.toggle-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.value === value);
        });
      }

      function updateSummary() {
        summary.innerHTML = '';
        const lines = [
          ['Mision', state.name || 'SIN NOMBRE'],
          ['Modo', state.mode],
          ['Dificultad', state.difficulty],
          ['Mapa', `${state.width}x${state.height}`],
          ['Altura', `${state.wallHeight}`],
          ['Vidas', `${state.lives}`],
          ['Seed', state.seed || 'AUTO'],
          ['Minimap', `${state.minimapRadius} celdas`],
          ['Pacman', state.pacman ? 'ACTIVO' : 'INACTIVO'],
        ];
        lines.forEach(([label, value]) => {
          const row = document.createElement('div');
          row.className = 'summary-item';
          row.innerHTML = `<span>${label}</span><span>${value}</span>`;
          summary.appendChild(row);
        });
      }

      function syncState() {
        state.name = missionName.value.trim();
        state.width = normalizeOdd(widthInput.value, state.width);
        state.height = normalizeOdd(heightInput.value, state.height);
        widthInput.value = state.width;
        heightInput.value = state.height;
        state.wallHeight = Math.max(1, Math.min(4, Number(wallHeightInput.value) || 2));
        wallHeightInput.value = state.wallHeight;
        state.lives = Math.max(1, Math.min(6, Number(livesInput.value) || 3));
        livesInput.value = state.lives;
        state.seed = seedInput.value.trim();
        state.pacman = pacmanToggle.checked;
        state.minimapRadius = Math.max(3, Math.min(12, Number(minimapRadius.value) || 7));
        minimapRadiusValue.textContent = String(state.minimapRadius);
        updateSummary();
      }

      async function loadOptions() {
        try {
          const modes = await fetch(MODE_URL).then((res) => res.json());
          modeGroup.innerHTML = '';
          modes.modos.forEach((mode) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'toggle-btn';
            btn.dataset.value = mode.id;
            btn.textContent = mode.nombre || mode.id;
            btn.addEventListener('click', () => {
              state.mode = mode.id;
              setActive(modeGroup, mode.id);
              updateSummary();
            });
            modeGroup.appendChild(btn);
          });
        } catch {
          modeGroup.innerHTML = '';
          ['modo_classic'].forEach((mode) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'toggle-btn';
            btn.dataset.value = mode;
            btn.textContent = mode;
            btn.addEventListener('click', () => {
              state.mode = mode;
              setActive(modeGroup, mode);
              updateSummary();
            });
            modeGroup.appendChild(btn);
          });
        }

        try {
          const diff = await fetch(DIFF_URL).then((res) => res.json());
          diffGroup.innerHTML = '';
          Object.keys(diff.niveles).forEach((key) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'toggle-btn';
            btn.dataset.value = key;
            btn.textContent = key.toUpperCase();
            btn.addEventListener('click', () => {
              state.difficulty = key;
              setActive(diffGroup, key);
              updateSummary();
            });
            diffGroup.appendChild(btn);
          });
        } catch {
          diffGroup.innerHTML = '';
          ['normal'].forEach((key) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'toggle-btn';
            btn.dataset.value = key;
            btn.textContent = key.toUpperCase();
            btn.addEventListener('click', () => {
              state.difficulty = key;
              setActive(diffGroup, key);
              updateSummary();
            });
            diffGroup.appendChild(btn);
          });
        }

        sizeGroup.innerHTML = '';
        sizes.forEach((size) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'toggle-btn';
          btn.dataset.value = size.id;
          btn.textContent = size.label;
          btn.addEventListener('click', () => {
            state.width = size.width;
            state.height = size.height;
            widthInput.value = size.width;
            heightInput.value = size.height;
            setActive(sizeGroup, size.id);
            updateSummary();
          });
          sizeGroup.appendChild(btn);
        });
      }

      function randomSeed() {
        const parts = ['nova', 'delta', 'orion', 'vega', 'lima', 'echo', 'zen', 'kappa', 'omega'];
        const code = Math.floor(Math.random() * 900 + 100);
        return `${parts[Math.floor(Math.random() * parts.length)]}-${parts[Math.floor(Math.random() * parts.length)]}-${code}`;
      }

      function loadConfig() {
        try {
          const raw = localStorage.getItem(CONFIG_KEY);
          if (!raw) return;
          const cfg = JSON.parse(raw);
          if (cfg.mode) state.mode = cfg.mode;
          if (cfg.difficulty) state.difficulty = cfg.difficulty;
          if (cfg.worldWidth) {
            state.width = normalizeOdd(cfg.worldWidth, state.width);
            widthInput.value = state.width;
          }
          if (cfg.worldHeight) {
            state.height = normalizeOdd(cfg.worldHeight, state.height);
            heightInput.value = state.height;
          }
          if (cfg.lives) {
            state.lives = Math.max(1, Math.min(6, Number(cfg.lives) || state.lives));
            livesInput.value = state.lives;
          }
        } catch {
          // ignore
        }
      }

      function saveConfig() {
        const cfg = {
          mode: state.mode,
          difficulty: state.difficulty,
          worldWidth: state.width,
          worldHeight: state.height,
          lives: state.lives,
          autosaveOnExit: true,
        };
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      }

      function startGame() {
        syncState();
        saveConfig();
        const params = new URLSearchParams();
        params.set('load', 'new');
        params.set('mode', state.mode);
        params.set('difficulty', state.difficulty);
        params.set('width', state.width);
        params.set('height', state.height);
        params.set('wallHeight', state.wallHeight);
        params.set('minimapRadius', state.minimapRadius);
        if (state.seed) params.set('seed', state.seed);
        if (state.name) params.set('name', state.name);
        if (state.pacman) params.set('pacman', '1');
        window.location.href = `game.html?${params.toString()}`;
      }

      missionName.addEventListener('input', syncState);
      widthInput.addEventListener('change', syncState);
      heightInput.addEventListener('change', syncState);
      livesInput.addEventListener('change', syncState);
      wallHeightInput.addEventListener('change', syncState);
      seedInput.addEventListener('input', syncState);
      pacmanToggle.addEventListener('change', syncState);
      minimapRadius.addEventListener('input', syncState);

      seedRandom.addEventListener('click', () => {
        seedInput.value = randomSeed();
        syncState();
      });

      startBtn.addEventListener('click', startGame);
      loadBtn.addEventListener('click', () => {
        window.location.href = 'worlds.html';
      });

      await loadOptions();
      loadConfig();
      setActive(modeGroup, state.mode);
      setActive(diffGroup, state.difficulty);
      setActive(sizeGroup, 'medium');
      syncState();
    </script>
    <script type="module" src="../ui/router.js"></script>
  </body>
</html>
