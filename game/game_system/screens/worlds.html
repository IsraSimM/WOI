<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Worlds</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <link rel="stylesheet" href="../styles/worlds.css" />
  </head>
  <body>
    <div class="container">
      <div class="title-section">
        <h1 class="title">
          <span class="title-world">WORLD</span>
          <span class="title-it">SELECT</span>
        </h1>
      </div>

      <div class="panel" id="savedPanel">
        <h2>Partida guardada</h2>
        <p>Continua exactamente donde lo dejaste.</p>
        <div class="meta" id="savedMeta">No hay datos</div>
        <div class="panel-actions">
          <button class="menu-btn primary" id="continueBtn">Continuar</button>
          <button class="menu-btn" id="deleteBtn">Borrar ultimo</button>
        </div>
      </div>

      <div class="panel" id="listPanel">
        <h2>Guardados</h2>
        <p>Lista completa de snapshots.</p>
        <div id="savesList"></div>
        <div class="meta" id="emptyMsg">No hay guardados.</div>
      </div>

      <div class="panel">
        <h2>Mundo 01</h2>
        <p>Mapa base con objetivos fijos, ideal para pruebas rapidas.</p>
        <div class="panel-actions">
          <button class="menu-btn primary" id="world01Btn">Iniciar Mundo 01</button>
          <button class="menu-btn" id="randomBtn">Nuevo Procedural</button>
        </div>
      </div>

      <div class="menu">
        <button class="menu-btn" data-route="config.html">Configuracion</button>
        <button class="menu-btn" data-route="index.html">Volver</button>
      </div>
    </div>
    <script type="module">
      const SAVE_LIST_KEY = 'world_snapshots_v1';
      const SAVE_LATEST_KEY = 'world_snapshot_latest_v1';

      const savedPanel = document.getElementById('savedPanel');
      const savedMeta = document.getElementById('savedMeta');
      const continueBtn = document.getElementById('continueBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const world01Btn = document.getElementById('world01Btn');
      const randomBtn = document.getElementById('randomBtn');
      const savesList = document.getElementById('savesList');
      const emptyMsg = document.getElementById('emptyMsg');

      function loadList() {
        try {
          const raw = localStorage.getItem(SAVE_LIST_KEY);
          if (!raw) return [];
          const list = JSON.parse(raw);
          return Array.isArray(list) ? list : [];
        } catch {
          return [];
        }
      }

      function saveList(list) {
        localStorage.setItem(SAVE_LIST_KEY, JSON.stringify(list));
      }

      function formatMeta(entry) {
        const created = entry.createdAt ? new Date(entry.createdAt).toLocaleString() : 'desconocido';
        const size = entry.data?.width && entry.data?.height ? `${entry.data.width}x${entry.data.height}` : 'N/A';
        const items = entry.data?.spawns?.items?.length ?? 0;
        const enemies = entry.data?.spawns?.enemies?.length ?? 0;
        return `Guardado: ${created} | Mapa: ${size} | Items: ${items} | Enemigos: ${enemies}`;
      }

      function getLatest(list) {
        const latestId = localStorage.getItem(SAVE_LATEST_KEY);
        if (latestId) {
          const entry = list.find((s) => s.id === latestId);
          if (entry) return entry;
        }
        return list[list.length - 1];
      }

      function updateSavedPanel(list) {
        if (!list.length) {
          savedPanel.style.display = 'none';
          return;
        }
        const latest = getLatest(list);
        savedMeta.textContent = formatMeta(latest);
        continueBtn.onclick = () => {
          window.location.href = 'game.html?load=latest';
        };
        deleteBtn.onclick = () => {
          const updated = list.filter((s) => s.id !== latest.id);
          saveList(updated);
          if (updated.length) {
            localStorage.setItem(SAVE_LATEST_KEY, updated[updated.length - 1].id);
          } else {
            localStorage.removeItem(SAVE_LATEST_KEY);
          }
          render();
        };
      }

      function renderList(list) {
        savesList.innerHTML = '';
        if (!list.length) {
          emptyMsg.style.display = 'block';
          return;
        }
        emptyMsg.style.display = 'none';
        const ordered = [...list].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        ordered.forEach((entry) => {
          const card = document.createElement('div');
          card.className = 'save-card';

          const title = document.createElement('div');
          title.className = 'save-title';
          title.textContent = entry.name || 'World';

          const meta = document.createElement('div');
          meta.className = 'save-meta';
          meta.textContent = formatMeta(entry);

          const actions = document.createElement('div');
          actions.className = 'save-actions';

          const loadBtn = document.createElement('button');
          loadBtn.className = 'menu-btn primary';
          loadBtn.textContent = 'Cargar';
          loadBtn.onclick = () => {
            window.location.href = `game.html?load=save&id=${entry.id}`;
          };

          const renameBtn = document.createElement('button');
          renameBtn.className = 'menu-btn';
          renameBtn.textContent = 'Renombrar';
          renameBtn.onclick = () => {
            const name = prompt('Nuevo nombre', entry.name || 'World');
            if (!name) return;
            entry.name = name.trim();
            saveList(list);
            render();
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'menu-btn';
          deleteBtn.textContent = 'Borrar';
          deleteBtn.onclick = () => {
            const updated = list.filter((s) => s.id !== entry.id);
            saveList(updated);
            if (localStorage.getItem(SAVE_LATEST_KEY) === entry.id) {
              if (updated.length) localStorage.setItem(SAVE_LATEST_KEY, updated[updated.length - 1].id);
              else localStorage.removeItem(SAVE_LATEST_KEY);
            }
            render();
          };

          actions.appendChild(loadBtn);
          actions.appendChild(renameBtn);
          actions.appendChild(deleteBtn);

          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(actions);
          savesList.appendChild(card);
        });
      }

      function render() {
        const list = loadList();
        updateSavedPanel(list);
        renderList(list);
      }

      world01Btn.addEventListener('click', () => {
        window.location.href = 'game.html?load=world_01';
      });

      randomBtn.addEventListener('click', () => {
        window.location.href = 'create.html';
      });

      render();
    </script>
    <script type="module" src="../ui/router.js"></script>
  </body>
</html>
